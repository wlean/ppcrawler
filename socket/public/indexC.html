<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>SocketIO test</title>
</head>
<body>
    <input type="text" name="msg" id="msg">
    <input type="submit" value="feedback" onclick="feedback()">
    <input type="submit" value="startUpload" onclick="startUpload()">
    <input type="submit" value="finish" onclick="finish()">
    <input type="submit" value="sendRcgnt" onclick="sendRcgnt()">
    <input type="submit" value="stopR" onclick="stopR()">
    <input type="submit" value="uploadBuffer" onclick="uploadBuffer()">
    <audio id="audio" controls></audio>
    <div class="record">
        <ul id="records"></ul>
    </div>
    <script src="socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="laudio.js"></script>
    <script src="recorderWorker.js"></script>
    <script src="recorder.js"></script>
    <script>
        var socket = io(window.location.hostname+':3442/app');
        // const appConfig = {
        // "expire": 30, 
        // "option": { 
        //     "path": "/vd.maoc3.com", 
        //     "secure": true, 
        //     "extraHeaders": {
        //     }, 
        //     "rejectUnauthorized": false,
        //     "transports": ['websocket']
        // }, 
        // "autoOpen": true, 
        // "resource": 100
        // }
        // var socket1 = io('https://139.198.6.168:10444/app',appConfig.option);
        function send(){
            socket.emit('addAudio', {id:$('#msg').val()});
            return false;
        };
        let id = '';    
        function startUpload(){
            socket.emit('audio.exmple.pcm.request');
            socket.on('audio.exmple.pcm.data',(buffer)=>{
                socket.emit('audio.add',{buffer:buffer,recorder:'wlp'});
            });
        };
        socket.on('audio.id',(data)=>{
            if(id != data.id){
                id = data.id;
                socket.emit('audio.recognition',data)
            }
            console.log('id update',id);
        });
        socket.on('audio.finish',(data)=>{
            console.log('收到识别结果',data);
        });
        function finish(){
            socket.emit('audio.finish',{id:$('#msg').val()});
        };

        function sendRcgnt(){
            socket.emit('audio.recognition',{id:$('#msg').val()});
        };

        function feedback(){
            socket.emit('audio.feedback',{id:$('#msg').val(),data:{'123123':'：AD发生的'}})
        };

        socket.on('audio.respond',(data)=>{
            $('#records').append('<li>'+JSON.stringify(data)+'</li>');
            finish();
        });
        let xxbuf = new ArrayBuffer(100);
        function uploadBuffer(){
            socket.emit('audio.exmple.pcm.request');
            socket.on('audio.exmple.pcm.data',(data)=>{
                $('#msg').val(data.id);
                socket.emit('audio.upload',data);
            })
        }
    </script>
</body>
</html>