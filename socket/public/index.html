<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>SocketIO test</title>
</head>
<body>
    <div class="record">
        <ul id="records"></ul>
    </div>
    <input type="text" name="msg" id="msg">
    <input type="submit" value="send" onclick="send()">
    <audio id="audio" controls></audio>
    <script src="socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="laudio.js"></script>
    <script>
        var socket = io(window.location.hostname+':3000');
        function send(){
            socket.emit('addAudio', {id:$('#msg').val()});
            $('#msg').val('');
            return false;
        };

        var la = laudio;
        socket.on('succ',function(msg){
            $('#records').append($('<li>').text(msg.msg+msg.id));
            if(msg.audio){
                la.audioCtx.decodeAudioData(msg.audio, function(buffer) {
                    dogBarkingBuffer = buffer;
                    la.addAudio(dogBarkingBuffer);
                }, ()=>console.log('error error'));
                la.play();
            }
            console.log(msg);
        });
        navigator.getUserMedia = navigator.getUserMedia||navigator.webkitGetUserMedia;
        if (navigator.getUserMedia) {
            navigator.getUserMedia(
                {
                    audio:true
                },
                function(localMediaStream){
                    var audioCtx = new AudioContext();
                    var audio = document.querySelector('audio');
                    audio.src = window.URL.createObjectURL(localMediaStream);
                    
                    audio.play();

                    var source = audioCtx.createMediaStreamSource(localMediaStream);
                    var scriptNode = audioCtx.createScriptProcessor(16384, 1, 1);
 
                    scriptNode.onaudioprocess = function(audioProcessingEvent) {
                        // The input buffer is the song we loaded earlier
                        var inputBuffer = audioProcessingEvent.inputBuffer;
                        var outputBuffer = audioProcessingEvent.outputBuffer;
                        // Loop through the output channels (in this case there is only one)
                        for (var channel = 0; channel < outputBuffer.numberOfChannels; channel++) {
                            var inputData = inputBuffer.getChannelData(channel).buffer;
                            var dataLength = inputData.byteLength;
                            var buffer = new ArrayBuffer(44 + dataLength);
                            var view = new DataView(buffer);
                            var sampleRateTmp = 11205 ;//sampleRate;//写入新的采样率
                            var sampleBits = 8;
                            var channelCount = 1;
                            var offset = 0;
                            /* 资源交换文件标识符 */
                            writeString(view, offset, 'RIFF'); offset += 4;
                            /* 下个地址开始到文件尾总字节数,即文件大小-8 */
                            view.setUint32(offset, /*32*/ 36 + dataLength, true); offset += 4;
                            /* WAV文件标志 */
                            writeString(view, offset, 'WAVE'); offset += 4;
                            /* 波形格式标志 */
                            writeString(view, offset, 'fmt '); offset += 4;
                            /* 过滤字节,一般为 0x10 = 16 */
                            view.setUint32(offset, 16, true); offset += 4;
                            /* 格式类别 (PCM形式采样数据) */
                            view.setUint16(offset, 1, true); offset += 2;
                            /* 通道数 */
                            view.setUint16(offset, channelCount, true); offset += 2;
                            /* 采样率,每秒样本数,表示每个通道的播放速度 */
                            view.setUint32(offset, sampleRateTmp, true); offset += 4;
                            /* 波形数据传输率 (每秒平均字节数) 通道数×每秒数据位数×每样本数据位/8 */
                            view.setUint32(offset, sampleRateTmp * channelCount * (sampleBits / 8), true); offset +=4;
                            /* 快数据调整数 采样一次占用字节数 通道数×每样本的数据位数/8 */
                            view.setUint16(offset, channelCount * (sampleBits / 8), true); offset += 2;
                            /* 每样本数据位数 */
                            view.setUint16(offset, sampleBits, true); offset += 2;
                            /* 数据标识符 */
                            writeString(view, offset, 'data'); offset += 4;
                            /* 采样数据总数,即数据总大小-44 */
                            view.setUint32(offset, dataLength, true); offset += 4;
                            /* 采样数据 */
                            floatTo8BitPCM(view, 44, samples);
                            socket.emit('addAudio', {stream:view,id:'a'});
                        }
                    }
                    
                    source.connect(scriptNode);
                    scriptNode.connect(audioCtx.destination);
                }, function(error){
                    alert(error.name+error.message);
                }
            );
        }else {
            alert('你的浏览器不支持录音');
        }

        function writeString(view, offset, string){
            for (var i = 0; i < string.length; i++){
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
    </script>
</body>
</html>