<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>SocketIO test</title>
</head>
<body>
    <div class="record">
        <ul id="records"></ul>
    </div>
    <input type="text" name="msg" id="msg">
    <input type="submit" value="send" onclick="send()">
    <audio id="audio" controls></audio>
    <script src="socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="laudio.js"></script>
    <script>
        var socket = io(window.location.hostname+':3000');
        function send(){
            socket.emit('addAudio', {id:$('#msg').val()});
            $('#msg').val('');
            return false;
        };

        var la = laudio;
        socket.on('succ',function(msg){
            $('#records').append($('<li>').text(msg.msg+msg.id));
            if(msg.audio){
                la.audioCtx.decodeAudioData(msg.audio, function(buffer) {
                    dogBarkingBuffer = buffer;
                    la.addAudio(dogBarkingBuffer);
                }, ()=>console.log('error error'));
                la.play();
            }
            console.log(msg);
        });
        navigator.getUserMedia = navigator.getUserMedia||navigator.webkitGetUserMedia;
        if (navigator.getUserMedia) {
            navigator.getUserMedia(
                {
                    audio:true
                },
                function(localMediaStream){
                    var audioCtx = new AudioContext();
                    var audio = document.querySelector('audio');
                    audio.src = window.URL.createObjectURL(localMediaStream);
                    
                    audio.play();

                    var source = audioCtx.createMediaStreamSource(localMediaStream);
                    var scriptNode = audioCtx.createScriptProcessor(16384, 1, 1);
 
                    scriptNode.onaudioprocess = function(audioProcessingEvent) {
                        // The input buffer is the song we loaded earlier
                        var inputBuffer = audioProcessingEvent.inputBuffer;
                        var outputBuffer = audioProcessingEvent.outputBuffer;
                        // Loop through the output channels (in this case there is only one)
                        for (var channel = 0; channel < outputBuffer.numberOfChannels; channel++) {
                            var inputData = inputBuffer.getChannelData(channel);
                            socket.emit('addAudio', {stream:inputData.buffer,id:'a'});
                        }
                    }
                    
                    source.connect(scriptNode);
                    scriptNode.connect(audioCtx.destination);
                }, function(error){
                    alert(error.name+error.message);
                }
            );
        }else {
            alert('你的浏览器不支持录音');
        }
    </script>
</body>
</html>